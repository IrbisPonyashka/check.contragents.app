export default class clientHandler{constructor(t,e,i,n,s,a,r,o,c,l){this.entityId=t,this.entityElemId=e,this.fieldName=i,this.domain=n,this.input=s,this.inputParent=a,this.infoTag=r,this.btnClear=o,this.iconLoader=c,this.btnLink=l,this.messgeParent=document.querySelector("#success"),this.messgeElement=document.querySelector("#success .ui-alert"),this.btnLink.textContent="Создать",this.requisite=null,this.method=null,this.type=null,this.valueLength=null,this.valueLength="CRM_CONTACT"==t?"14":"9",this.entity="CRM_CONTACT"==t?"contact":"company",this.type="CRM_CONTACT"==t?"individual":"entity",this.input.setAttribute("maxlength",this.valueLength),this.input.addEventListener("input",(t=>this.processInput(t.target))),this.btnMergeContainer=l.parentElement.cloneNode(!0),this.btnMerge=this.btnMergeContainer.querySelector("button"),this.btnMerge.classList.add("ui-btn-icon-merger"),this.btnMerge.title="company"==this.entity?"Слияние данной компании с обнаруженным дубликатом":"Слияние данного контакта с обнаруженным дубликатом",this.renameCompanyTitle=!0,this.renameContactTitle=!0,this.entityPreset=[],this.individualPreset=[],BX24.callMethod("app.option.get",{},(async t=>{t.error()?console.error(t.data()):t.data().params&&(this.renameCompanyTitle=JSON.parse(t.data().params.renameCompany),this.renameContactTitle=JSON.parse(t.data().params.renameContact),this.entityPreset=await this.getPreset({order:{ID:"ASC"},filter:{ID:t.data().params.EntityPresetId},select:["ID","NAME"]}),this.individualPreset=await this.getPreset({order:{ID:"ASC"},filter:{ID:t.data().params.IndividaulPresetId},select:["ID","NAME"]}))})),this.btnClear.addEventListener("click",(t=>this.clearInput())),this.getAccesses(),0!=this.entityElemId&&this.setFieldValue(this.input,this.fieldName),this.input.addEventListener("input",(t=>this.processInput(t.target))),this.btnLink.addEventListener("click",(t=>this.actionChange())),this.btnMerge.addEventListener("click",(t=>this.mergeEntity(t))),this.btnClear.addEventListener("click",(t=>this.clearInput())),this.getAccesses(),setTimeout((()=>{""!=this.input.value&&(this.input.value=this.input.value.trim().replace(" ","").replace(" ",""),this.processInput(this.input))}),"1000")}async processInput(t){const e=t.value.trim().replace(" ","").replace(" ","");if(this.btnClear.style.display=e.length>0?"block":"none",null!=this.btnMergeContainer.parentElement&&(this.inputParent.removeChild(this.btnMergeContainer),this.btnMerge.setAttribute("disabled",!0)),this.isValidInn(e))if(0==this.entityElemId)this.setStatusToAction(),e.length==this.valueLength&&this.isValidInn(e)?sessionStorage.setItem("entityInn",e):e.length>=1&&e.length<=this.valueLength?this.setStatusToAction("invalid","Введите 9 цифр"):this.setStatusToAction("default");else if("entity"==this.type&&e.length==this.valueLength||"individual"==this.type&&e.length==this.valueLength||"contact"==this.entity&&14==e.length||"company"==this.entity&&null==this.type&&(14==e.length||9==e.length)&&this.isValidInn(e)){this.setLoading(!0),this.setStatusToAction("default","поиск..."),this.setValueToStorageField(e,this.fieldName);const t=await this.hasThisRq(e),i=await this.hasCompanyWithInn(e,this.entityElemId),n=await this.getDataAPIbyInn(e);null!=n&&isNaN(n)?(0==i?0!=t?(this.btnLink.textContent="contact"==this.entity?"Создать контакт":"Создать компанию",this.setStatusToAction("createAll")):(this.btnLink.textContent="Создать",this.setStatusToAction("create")):0==Array.isArray(i)?(this.requisite=i.ID,this.btnLink.textContent="contact"==this.entity?"Обновить контакт":"Обновить компанию",this.setStatusToAction("update")):(this.editSelectors("ui-btn-primary","ui-btn-disabled",this.btnMerge),this.editSelectors("ui-btn-primary","ui-btn-primary",this.btnMerge),this.btnMerge.removeAttribute("disabled"),this.inputParent.appendChild(this.btnMergeContainer),this.btnMerge.textContent="",this.btnLink.textContent="contact"==this.entity?"Перейти в контакт":"Перейти в компанию",this.setStatusToAction("link",`найдено дубликатов: ${i.length}`)),this.setLoading(!1)):522==n?(this.setLoading(!1),this.setStatusToAction("undefined","Что-то пошло не так, попробуйте позже.")):(this.setLoading(!1),this.setStatusToAction("undefined"))}else"entity"==this.type&&t.value.length>=1&&t.value.length<=9||"individual"==this.type&&t.value.length>=1&&t.value.length<=14||t.value.length>=1&&t.value.length<=this.valueLength?"contact"==this.entity?this.setStatusToAction("invalid","Введите 14 цифр"):this.setStatusToAction("invalid",null!=this.type?`Введите ${this.valueLength} цифр`:"Введите 9 цифр для ИНН или 14 цифр для ПИНФЛ"):this.setStatusToAction("default");else this.setStatusToAction("invalid")}async actionChange(){this.setLoading(!0);const t=this.input.value.trim().replace(" ","").replace(" ",""),e=await this.getDataAPIbyInn(t);var i=[];if(i=null!=this.type?"entity"==this.type?this.entityPreset:this.individualPreset:9==t.length?this.entityPreset:this.individualPreset,console.log(this.entityPreset,this.individualPreset),"create"==this.method){await this.companyRqAdd(e.data,i[0],this.entityElemId,t,this.fieldName)&&(window.top.location.href=`https://${this.domain}/crm/${this.entity}/details/${this.entityElemId}/`)}else if("createAll"==this.method){const n=await this.createCompanyWithRq(e.data,i[0],this.fieldName,t);if(n){this.setStatusToAction("link",""+("contact"==this.entity?"Контакт создан и заполнен":"Компания создана и заполнена")),this.btnLink.textContent="contact"==this.entity?"Перейти в контакт":"Перейти в компанию";let t=document.createElement("a");t.style.display="none",t.target="_blank",t.href=`https://${this.domain}/crm/${this.entity}/details/${n}/`,document.querySelector("#check__btn-container").appendChild(t),t.click()}}else if("update"==this.method&&null!=this.requisite){await this.companyRqUpdate(e.data,i[0],this.entityElemId,this.requisite,t)&&(window.top.location.href=`https://${this.domain}/crm/${this.entity}/details/${this.entityElemId}/`)}else if("link"==this.method){const e=await this.hasCompanyWithInn(t,this.entityElemId);let i=document.createElement("a");i.style.display="none",i.target="_blank",i.href=`https://${this.domain}/crm/${this.entity}/details/${e[0].ENTITY_ID}/`,document.querySelector("#check__btn-container").appendChild(i),i.click()}this.setLoading(!1)}async deleteEntity(t,e=this.entity){const i=this.input.value.trim().replace(" ","").replace(" ",""),n=this.domain,s=this.entityElemId,a=await this.hasCompanyWithInn(i,s);BX24.callMethod(`crm.${this.entity}.delete`,{id:s},(function(t){if(t.error())console.log(t.error());else{let t=document.createElement("a");t.style.display="none",t.target="_blank",t.href=`https://${n}/crm/${e}/details/${a[0].ENTITY_ID}/`,document.querySelector("#check__btn-container").appendChild(t),t.click(),window.top.location.href=`https://${n}/crm/${e}/details/${s}/`}}))}async mergeEntity(t,e=this.entity){const i=this.domain,n=this.input.value.trim().replace(" ","").replace(" ",""),s=this.entityElemId;let a=(await this.hasCompanyWithInn(n,s)).map((t=>t.ENTITY_ID));a.push(s),BX24.callMethod("crm.entity.mergeBatch",{params:{entityTypeId:"contact"==this.entity?3:4,entityIds:a}},(function(t){if(t.error())console.log(t);else{let n=document.createElement("a");n.style.display="none",n.target="_blank","CONFLICT"==t.data().STATUS?(n.href=`https://${i}/crm/${e}/merge/?id=${a.toString()}`,document.querySelector("#check__btn-container").appendChild(n),n.click()):"SUCCESS"==t.data().STATUS&&(window.top.location.href=`https://${i}/crm/${e}/details/${s}/`)}}))}async getDataAPIbyInn(t){try{var e=new Headers;return e.append("Authorization",`Bearer ${JSON.parse(sessionStorage.token).access_token}`),fetch(`https://api.multibank.uz/api/check_contragent/v1/gnk/${t}?refresh=1`,{method:"GET",headers:e,redirect:"follow"}).then((t=>t.text())).then((t=>JSON.parse(t).success?JSON.parse(t):JSON.parse(t).code)).catch((t=>console.log("error",t)))}catch(t){console.log(t)}}async hasCompanyWithInn(t,e,i=this.entity){return new Promise(((n,s)=>{var a={};"company"==i?(a.RQ_INN=t,a.ENTITY_TYPE_ID=4):(a.RQ_INN=t,a.ENTITY_TYPE_ID=3),BX24.callMethod("crm.requisite.list",{filter:a,select:["ID","NAME","RQ_COMPANY_NAME","ENTITY_ID"]},(function(t){if(t.error())n(t.error());else if(t.data().length>0){const i=t.data().filter((t=>t.ENTITY_ID==e));null!=i[0]?n(i[0]):n(t.data())}else n(!1)}))}))}async hasThisRq(){return new Promise(((t,e)=>{BX24.callMethod("crm.requisite.list",{filter:{ENTITY_ID:this.entityElemId},select:["ID","NAME","RQ_COMPANY_NAME"]},(function(e){e.error()?console.error(e.error()):e.data().length>0?t(e.data()):t(!1)}))}))}async createCompanyWithRq(t,e,i,n,s=this.entity){return new Promise(((a,r)=>{var o={};const c=!!t.gnk_company_director_name&&t.gnk_company_director_name.split(" ");"company"==s?o.TITLE=t.gnk_company_name:"contact"==s&&(o.LAST_NAME=c?c[0]:"",o.NAME=c?c[1]:"",o.SECOND_NAME=c?c[2]:""),o[i]=n,BX24.callMethod(`crm.${this.entity}.add`,{fields:o,params:{REGISTER_SONET_EVENT:"Y"}},(async i=>{i.error()?a(i.error()):BX24.callBatch({crmRequisiteAdd:{method:"crm.requisite.add",params:{fields:{ENTITY_TYPE_ID:"contact"==s?3:4,ENTITY_ID:i.data(),PRESET_ID:e.ID,ACTIVE:"Y",NAME:e.NAME,RQ_INN:"contact"==s?t.gnk_company_director_pinfl:t.company_tin,UF_CRM_RQ_PINFL:"contact"==s?t.gnk_company_director_pinfl:t.company_tin,RQ_COMPANY_NAME:t.gnk_company_name,RQ_COMPANY_FULL_NAME:t.gnk_company_name_full,RQ_DIRECTOR:t.gnk_company_director_name+(t.gnk_company_director_tin?` - ${t.gnk_company_director_tin}`:"")+(t.gnk_company_director_pinfl?` - ${t.gnk_company_director_pinfl}`:""),RQ_ACCOUNTANT:t.gnk_company_accountant,RQ_OKVED:t.gnk_company_oked,RQ_LAST_NAME:t.gnk_company_director_name?c[0]:"",RQ_FIRST_NAME:t.gnk_company_director_name?c[1]:"",RQ_SECOND_NAME:t.gnk_company_director_name?c[2]:""}}},crmAddressAdd:{method:"crm.address.add",params:{fields:{TYPE_ID:6,ENTITY_TYPE_ID:8,ENTITY_ID:"$result[crmRequisiteAdd]",ADDRESS_1:t.gnk_company_address}}},crmBankdetailAdd:{method:"crm.requisite.bankdetail.add",params:{fields:{ENTITY_ID:"$result[crmRequisiteAdd]",COUNTRY_ID:1,NAME:"Первичный счёт",RQ_BIK:t.gnk_company_mfo,RQ_ACC_NUM:t.gnk_company_account,RQ_ACC_CURRENCY:"Узбекский сум"}}}},(t=>{a(i.data())}))}))}))}async companyRqAdd(t,e,i,n,s,a=this.entity){return new Promise(((r,o)=>{let c=t.gnk_company_director_name.split(" ");BX24.callBatch({crmRequisiteAdd:{method:"crm.requisite.add",params:{fields:{ENTITY_TYPE_ID:"contact"==a?3:4,ENTITY_ID:this.entityElemId,PRESET_ID:e.ID,ACTIVE:"Y",NAME:e.NAME,RQ_INN:"contact"==a?t.gnk_company_director_pinfl:t.company_tin,RQ_COMPANY_NAME:t.gnk_company_name,RQ_COMPANY_FULL_NAME:t.gnk_company_name_full,RQ_DIRECTOR:t.gnk_company_director_name+(t.gnk_company_director_tin?` - ${t.gnk_company_director_tin}`:"")+(t.gnk_company_director_pinfl?` - ${t.gnk_company_director_pinfl}`:""),RQ_ACCOUNTANT:t.gnk_company_accountant,RQ_OKVED:t.gnk_company_oked,RQ_LAST_NAME:t.gnk_company_director_name?c[0]:"",RQ_FIRST_NAME:t.gnk_company_director_name?c[1]:"",RQ_SECOND_NAME:t.gnk_company_director_name?c[2]:""}}},crmAddressAdd:{method:"crm.address.add",params:{fields:{TYPE_ID:6,ENTITY_TYPE_ID:8,ENTITY_ID:"$result[crmRequisiteAdd]",ADDRESS_1:t.gnk_company_address}}},crmBankdetailAdd:{method:"crm.requisite.bankdetail.add",params:{fields:{ENTITY_ID:"$result[crmRequisiteAdd]",COUNTRY_ID:1,NAME:"Первичный счёт",RQ_BIK:t.gnk_company_mfo,RQ_ACC_NUM:t.gnk_company_account,RQ_ACC_CURRENCY:"Узбекский сум"}}}},(e=>{var o=s,l={};"company"==a&&this.renameCompanyTitle?l.TITLE=t.gnk_company_name:"contact"==a&&this.renameContactTitle&&(l.LAST_NAME=c?c[0]:"",l.NAME=c?c[1]:"",l.SECOND_NAME=c?c[2]:""),l[o]=n,BX24.callMethod(`crm.${a}.update`,{id:i,fields:l,params:{REGISTER_SONET_EVENT:"N"}},(function(t){t.error()?(console.info(t.error()),r(t.error())):r(t.data())}))}))}))}async companyRqUpdate(t,e,i,n,s,a=this.fieldName,r=this.entity){return new Promise(((o,c)=>{const l=!!t.gnk_company_director_name&&t.gnk_company_director_name.split(" ");BX24.callBatch({crmRequisiteUpdate:{method:"crm.requisite.update",params:{id:n,fields:{ENTITY_TYPE_ID:"contact"==r?3:4,ENTITY_ID:this.entityElemId,PRESET_ID:e.ID,ACTIVE:"Y",NAME:e.NAME,RQ_INN:"contact"==r?t.gnk_company_director_pinfl:t.company_tin,RQ_COMPANY_NAME:t.gnk_company_name,RQ_COMPANY_FULL_NAME:t.gnk_company_name_full,RQ_DIRECTOR:t.gnk_company_director_name+(t.gnk_company_director_tin?` - ${t.gnk_company_director_tin}`:"")+(t.gnk_company_director_pinfl?` - ${t.gnk_company_director_pinfl}`:""),RQ_ACCOUNTANT:t.gnk_company_accountant,RQ_OKVED:t.gnk_company_oked,RQ_LAST_NAME:t.gnk_company_director_name?l[0]:"",RQ_FIRST_NAME:t.gnk_company_director_name?l[1]:"",RQ_SECOND_NAME:t.gnk_company_director_name?l[2]:""}}},crmBankdetailList:{method:"crm.requisite.bankdetail.list",params:{filter:{ENTITY_ID:n},select:["ID","NAME","ENTITY_ID"]}},crmBankdetailUpdate:{method:"crm.requisite.bankdetail.update",params:{id:"$result[crmBankdetailList][0][ID]",fields:{ENTITY_ID:n,COUNTRY_ID:1,NAME:"Первичный счёт",RQ_BIK:t.gnk_company_mfo,RQ_ACC_NUM:t.gnk_company_account,RQ_ACC_CURRENCY:"Узбекский сум"}}}},(e=>{var n=a,c={};"company"==r&&this.renameCompanyTitle?c.TITLE=t.gnk_company_name:"contact"==r&&this.renameContactTitle&&(c.NAME=l?l[0]:"",c.LAST_NAME=l?l[1]:"",c.SECOND_NAME=l?l[2]:""),c[n]=s,BX24.callMethod(`crm.${r}.update`,{id:i,fields:c,params:{REGISTER_SONET_EVENT:"N"}},(function(t){t.error()?(console.info(t.error()),o(t.error())):o(t.data())}))}))}))}async getPreset(t){return new Promise(((e,i)=>{BX24.callMethod("crm.requisite.preset.list",t,(function(t){t.error()?e(null):e(t.data())}))}))}setFieldValue(t,e){if(console.log(t,e),sessionStorage.entityInn){t.value=sessionStorage.entityInn;var i={};i[e]=t.value,BX24.callMethod(`crm.${this.entity}.update`,{id:this.entityElemId,fields:i},(function(t){t.error()?console.error(t.error()):sessionStorage.removeItem("entityInn")}))}else BX24.callMethod(`crm.${this.entity}.get`,{id:this.entityElemId},(i=>{i.error()?console.error(i.error()):(console.log(i.data()[e]),i.data()[e]?t.value=i.data()[e]:BX24.callMethod("crm.requisite.list",{filter:{ENTITY_ID:this.entityElemId}},(e=>{console.log(e),e.error()?console.error(e.error()):e.data().length>0&&(t.value=e.data()[0].RQ_INN)})))}))}setValueToStorageField(t,e=this.fieldName){var i={};i[e]=t,BX24.callMethod(`crm.${this.entity}.update`,{id:this.entityElemId,fields:i},(t=>{}))}getAccesses(){BX24.callMethod("app.option.get",{},(function(t){if(t.error())console.error(t.data());else{let i=t.data();if(!sessionStorage.token){const t="8",n="kV6eVfCQ1u1iVR6Def4K5mMQc9M1NG5t9PS4K1IJ";var e=new FormData;e.append("grant_type","password"),e.append("client_id",t),e.append("client_secret",n),e.append("scope",""),e.append("username",i.login),e.append("password",i.password),fetch("https://auth.multibank.uz/oauth/token",{method:"POST",body:e,redirect:"follow"}).then((t=>t.text())).then((t=>{sessionStorage.setItem("token",t)})).catch((t=>console.log("error",t)))}}}))}editSelectors(t,e,i){i.classList.remove(e),i.classList.add(t)}showMessge(t){this.messgeElement.innerHTML=t,this.inputParent.style.display="none",this.messgeParent.style.display="block"}cleanSpaces(t){}clearInput(){this.input.value=""}setLoading(t){t?(this.btnClear.style.display="none",this.iconLoader.style.display="block"):(this.btnClear.style.display="block",this.iconLoader.style.display="none")}isValidInn(t){return 0==t.length||/^[-+]?\d+(\.\d*)?$/.test(t)}setFieldStatus(t,e,i,n){let s="ui-ctl-",a="ui-btn-",r="ui-ctl-tag-";["primary","success","warning","danger","disabled"].forEach((o=>{e.classList.contains(`${s}${o}`)&&e.classList.remove(`${s}${o}`),n.classList.contains(`${a}${o}`)&&n.classList.remove(`${a}${o}`),i.classList.contains(`${r}${o}`)&&i.classList.remove(`${r}${o}`),o==t&&(e.classList.add(`${s}${t}`),n.classList.add(`${a}${t}`),i.classList.add(`${r}${t}`))}))}setStatusToAction(t,e){this.method=t,"create"==t?(this.infoTag.textContent="новый",this.setFieldStatus("success",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"default"==t?(this.infoTag.textContent=`Введите ${"contact"==this.entity?"14":"9"} цифр`,this.inputParent.classList.remove("ui-ctl-primary"),this.setFieldStatus("primary",this.inputParent,this.infoTag,this.btnLink),this.btnLink.setAttribute("disabled",!0)):"update"==t?(this.infoTag.textContent="Обновление данных",this.setFieldStatus("success",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"createAll"==t?(this.infoTag.textContent=e||"Реквизиты уже заполнены. "+("contact"==this.entity?"Будет создан новый контакт.":"Будет создана новая компания."),this.setFieldStatus("success",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"link"==t?(this.infoTag.textContent=e||""+("contact"==this.entity?"Данный контакт уже существует":"Данная компания уже существует"),this.setFieldStatus("success",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"invalid"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent=e||"Некорректный формат ИНН",this.setFieldStatus("danger",this.inputParent,this.infoTag,this.btnLink)):"error"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent="Что-то пошло не так, попробуйте еще раз!",this.setFieldStatus("danger",this.inputParent,this.infoTag,this.btnLink)):"undefined"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent="ИНН не найден",this.setFieldStatus("warning",this.inputParent,this.infoTag,this.btnLink)):(this.infoTag.textContent=e||"Заполнение будет доступно после сохранения "+("contact"==this.entity?"контакта":"компании"),this.setFieldStatus("primary",this.inputParent,this.infoTag,this.btnLink),this.btnLink.setAttribute("disabled",!0))}}