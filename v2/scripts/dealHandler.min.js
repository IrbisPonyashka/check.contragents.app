export default class DealCompanyHandler{constructor(t,e,a,n,i,s,r,o,l,d){this.entityElemId=e,this.entityId=t,this.domain=n,this.input=i,this.fieldName=a,this.inputParent=s,this.infoTag=r,this.btnClear=o,this.iconLoader=l,this.btnLink=d,this.valueLength=14,this.entity="deal",this.messgeParent=document.querySelector("#success"),this.messgeElement=document.querySelector("#success .ui-alert"),this.btnLink.textContent="Привязать",this.method=null,this.input.setAttribute("maxlength",this.valueLength),this.btnClear.addEventListener("click",(t=>this.clearInput())),this.getAccesses(),this.input.value=localStorage.dealInn?localStorage.dealInn:"",0!=this.entityElemId&&this.setFieldValue(this.input,this.fieldName),this.entityPreset=[],this.individualPreset=[],BX24.callMethod("app.option.get",{},(async t=>{t.error()?console.error(t.data()):t.data().params&&(this.renameCompanyTitle=JSON.parse(t.data().params.renameCompany),this.renameContactTitle=JSON.parse(t.data().params.renameContact),this.entityPreset=await this.getPreset({order:{ID:"ASC"},filter:{ID:t.data().params.EntityPresetId},select:["ID","NAME"]}),this.individualPreset=await this.getPreset({order:{ID:"ASC"},filter:{ID:t.data().params.IndividaulPresetId},select:["ID","NAME"]}))})),this.input.addEventListener("input",(t=>this.processInputInDeal(t.target))),this.btnLink.addEventListener("click",(t=>this.actionChangeInDeal())),setTimeout((()=>{""!=this.input.value&&(this.input.value=this.input.value.trim().replace(" ","").replace(" ",""),this.processInputInDeal(this.input))}),"500")}async processInputInDeal(t){const e=t.value.trim().replace(" ","").replace(" ","");if(this.btnClear.style.display=e.length>0?"block":"none",this.isValidInn(e))if(0==this.entityElemId);else if(9==e.length||14==e.length&&this.isValidInn(e)){const t=14==e.length?"contact":"company",a=await this.getCompanyIdByInn(e),n=this.entityElemId,i=await this.dealHasCompany(n,a,e);if(this.setLoading(!0),a)null==i?(this.btnLink.textContent="Привязать",this.setStatusToAction("binding",("contact"==t?"Контакт":"компания")+" имеется в CRM")):0!=i&&null!=i?(this.btnLink.textContent="Заменить "+("contact"==t?"контакт":"компанию"),this.setStatusToAction("binding")):(this.btnLink.textContent="Заменить "+("contact"==t?"контакт":"компанию"),this.setStatusToAction("equality",""+("contact"==t?"Контакт уже привязан к этой сделке":"Компания уже привязана к этой сделке"))),this.setLoading(!1);else{const a=await this.getDataAPI(e);if(null==a||404==a)return this.setStatusToAction("undefined"),void this.setLoading(!1);522==a?(this.setLoading(!1),this.setStatusToAction("undefined","Что-то пошло не так, попробуйте позже.")):(i?(this.btnLink.textContent=""+("contact"==t?"Заменить контакт":"Заменить компанию"),this.setStatusToAction("createWithBind")):(this.btnLink.textContent=""+("contact"==t?"Привязать контакт":"Привязать компанию"),this.setStatusToAction("createWithBind","Реквизиты найдены")),this.setLoading(!1))}}else e.length>=1&&e.length<=8?this.setStatusToAction("invalid","Введите 9 цифр для ИНН или 14 цифр для ПИНФЛ"):t.value.length>=10&&t.value.length<=13?this.setStatusToAction("invalid","Введите 14 цифр для ПИНФЛ"):this.setStatusToAction("default");else this.setStatusToAction("invalid")}async actionChangeInDeal(){this.setLoading(!0);const t=this.input.value.trim().replace(" ","").replace(" ",""),e=14==t.length?"contact":"company";var a=[];a="company"==e?this.entityPreset:this.individualPreset,console.log(a);const n=await this.getCompanyIdByInn(t),i=await this.dealHasCompany(this.entityElemId,n,t),s=await this.getDataAPI(t),r=await this.getNdsStatus(t);if(s.data.status_nds=r,"createWithBind"==this.method){let n=await this.createCompanyByInn(s,t,a[0],e);if(n){this.setLoading(!1),await this.bindCompanyToDeal(n,i,this.entityElemId,this.domain,s,e)&&(window.top.location.href=`https://${this.domain}/crm/deal/details/${this.entityElemId}/`)}else this.setLoading(!1),this.setStatusToAction("error")}else if("binding"==this.method&&n){this.setLoading(!1),await this.bindCompanyToDeal(n,i,this.entityElemId,this.domain,s,e)&&(window.top.location.href=`https://${this.domain}/crm/deal/details/${this.entityElemId}/`)}}async createCompanyByInn(t,e,a,n){const i=t.data;return new Promise(((t,s)=>{"Семейное предприятие"==i.gnk_na1Name||"Частное предприятие"==i.gnk_na1Name||i.gnk_na1Name;var r={};const o=!!i.gnk_company_director_name&&i.gnk_company_director_name.split(" ");"company"==n?r.TITLE=i.gnk_company_name:"contact"==n&&(r.LAST_NAME=o?o[0]:"",r.NAME=o?o[1]:"",r.SECOND_NAME=o?o[2]:""),r[this.fieldName]=e,BX24.callMethod(`crm.${n}.add`,{fields:r,params:{REGISTER_SONET_EVENT:"N"}},(async e=>{e.error()?t(e.error()):BX24.callBatch({crmRequisiteAdd:{method:"crm.requisite.add",params:{fields:{ENTITY_TYPE_ID:"contact"==n?3:4,ENTITY_ID:e.data(),PRESET_ID:a.ID,ACTIVE:"Y",NAME:a.NAME+` ${i.gnk_na1Name??""}`,RQ_INN:"contact"==n?i.gnk_company_director_pinfl:i.company_tin,RQ_COMPANY_NAME:i.gnk_company_name,RQ_COMPANY_FULL_NAME:i.gnk_company_name_full,RQ_DIRECTOR:i.gnk_company_director_name+(i.gnk_company_director_tin?` - ${i.gnk_company_director_tin}`:"")+(i.gnk_company_director_pinfl?` - ${i.gnk_company_director_pinfl}`:""),RQ_ACCOUNTANT:i.gnk_company_accountant,RQ_OKVED:i.gnk_company_oked,RQ_LAST_NAME:i.gnk_company_director_name?o[0]:"",RQ_FIRST_NAME:i.gnk_company_director_name?o[1]:"",RQ_SECOND_NAME:i.gnk_company_director_name?o[2]:""}}},crmAddressAdd:{method:"crm.address.add",params:{fields:{TYPE_ID:6,ENTITY_TYPE_ID:8,ENTITY_ID:"$result[crmRequisiteAdd]",ADDRESS_1:i.gnk_company_address}}},crmBankdetailAdd:{method:"crm.requisite.bankdetail.add",params:{fields:{ENTITY_ID:"$result[crmRequisiteAdd]",COUNTRY_ID:1,NAME:"Первичный счёт",RQ_BIK:i.gnk_company_mfo,RQ_ACC_NUM:i.gnk_company_account,RQ_ACC_CURRENCY:"Узбекский сум"}}}},(a=>{t(e.data())}))}))}))}async bindCompanyToDeal(t,e,a,n,i,s){return new Promise(((r,o)=>{const l=i.data;var d={};"contact"==s?(d.CONTACT_ID=t,d[this.fieldName]=l.gnk_company_director_pinfl):(d.COMPANY_ID=t,d[this.fieldName]=l.company_tin),BX24.callMethod("crm.deal.update",{id:this.entityElemId,fields:d,params:{REGISTER_SONET_EVENT:"Y"}},(t=>{t.error()?console.error(t.error()):e?BX24.callMethod(`crm.${s}.get`,{id:e},(t=>{t.error()?console.error(t.error()):BX24.callMethod("crm.timeline.comment.add",{fields:{ENTITY_ID:a,ENTITY_TYPE:"deal",COMMENT:`${"contact"==s?"Контакт был заменен":"Компания была заменена"}. При необходимости удалите ${"contact"==s?"предыдущий":"предыдущую"} - <a href="https://${n}/crm/${s}/details/${e}/">${t.data().TITLE}</a>.`}},(function(t){t.error()?console.error(t.error()):(console.info("Добавлен новый комментарий. ID - "+t.data()),r(!0))}))})):r(!0)}))}))}async getDataAPI(t){try{var e=new Headers;return e.append("Authorization",`Bearer ${JSON.parse(sessionStorage.token).access_token}`),fetch(`https://api.multibank.uz/api/check_contragent/v1/gnk/${t}?refresh=1`,{method:"GET",headers:e,redirect:"follow"}).then((t=>t.text())).then((t=>JSON.parse(t).success?JSON.parse(t):JSON.parse(t).code)).catch((t=>console.log("error",t)))}catch(t){console.log(t)}}async getNdsStatusPromise(t){var e=new Headers;e.append("Authorization",`Bearer ${JSON.parse(sessionStorage.token).access_token}`);var a={method:"GET",headers:e,redirect:"follow"};let n=new Date,i=n.getFullYear(),s=(n.getMonth()+1).toString().padStart(2,"0"),r=n.getDate().toString().padStart(2,"0");return fetch(`https://api.multibank.uz/api/edm/gnk/taxpayer_type?tin_or_pinfl=${t}&date=${`${i}-${s}-${r}`}`,a).then((t=>t.ok?t:Promise.reject(t))).then((t=>t.json())).catch((t=>t.status))}async getNdsStatus(t){try{const e=await this.getNdsStatusPromise(t);return e?e.data.name:""}catch(t){return""}}setFieldValue(t,e){if(sessionStorage.dealInn){t.value=sessionStorage.dealInn;var a={};a[e]=t.value,BX24.callMethod("crm.deal.update",{id:this.entityElemId,fields:a},(function(t){t.error()?console.error(t.error()):sessionStorage.removeItem("dealInn")}))}else BX24.callMethod("crm.deal.get",{id:this.entityElemId},(a=>{if(a.error())return console.error(a.error()),null;if(a.data()[e]&&"undefined"!=a.data()[e]&&this.isValidInn(a.data()[e])){t.value=a.data()[e];let n={};n[e]=a.data()[e],BX24.callMethod("crm.deal.update",{id:a.data().ID,fields:n},(function(t){t.error()&&console.error(t.error())}))}}))}getAccesses(){BX24.callMethod("app.option.get",{},(function(t){if(t.error())console.error(t.data());else{let a=t.data();if(!sessionStorage.token){const t="8",n="kV6eVfCQ1u1iVR6Def4K5mMQc9M1NG5t9PS4K1IJ";var e=new FormData;e.append("client_id",t),e.append("client_secret",n),e.append("username",a.login),e.append("password",a.password),e.append("scope",""),e.append("grant_type","password"),fetch("https://auth.multibank.uz/oauth/token",{method:"POST",body:e,redirect:"follow"}).then((t=>t.text())).then((t=>{JSON.parse(t).error,sessionStorage.setItem("token",t)})).catch((t=>console.log("error",t)))}}}))}async getCompanyIdByInn(t){return new Promise(((e,a)=>{let n={RQ_INN:t};n.ENTITY_TYPE_ID=14==t.length?3:4,BX24.callMethod("crm.requisite.list",{filter:n,select:["ID","NAME","RQ_COMPANY_NAME","ENTITY_ID","RQ_INN"]},(function(t){t.error()?(console.error("ERROR: "+t.error()),e(null)):(console.log(t.data()),t.data().length?e(t.data()[0].ENTITY_ID):e(null))}))}))}async getCompanyIdById(t){return new Promise(((e,a)=>{BX24.callMethod("crm.company.get",{id:t},(function(t){t.error()?(console.error("ERROR: "+t.error()),e(null)):e(t.data())}))}))}dealHasCompany(t,e,a){return new Promise(((n,i)=>{BX24.callMethod("crm.deal.get",{id:t},(t=>{if(t.error())return console.error(t.error()),null;14==a.length?0==t.data().CONTACT_ID||null==t.data().CONTACT_ID?n(null):t.data().CONTACT_ID==e?n(!1):n(t.data().CONTACT_ID):0==t.data().COMPANY_ID||null==t.data().COMPANY_ID?n(null):t.data().COMPANY_ID==e?n(!1):n(t.data().COMPANY_ID)}))}))}async getPreset(t){return new Promise(((e,a)=>{BX24.callMethod("crm.requisite.preset.list",t,(function(t){t.error()?e(null):e(t.data())}))}))}showMessge(t){this.messgeElement.innerHTML=t,this.inputParent.style.display="none",this.messgeParent.style.display="block"}cleanSpaces(t){t.preventDefault();var e="";window.clipboardData&&window.clipboardData.getData?e=window.clipboardData.getData("Text"):t.clipboardData&&t.clipboardData.getData&&(e=t.clipboardData.getData("text/plain")),this.value=e.replace(/\s/g,"")}clearInput(){this.input.value=""}setLoading(t){t?(this.btnClear.style.display="none",this.iconLoader.style.display="block"):(this.btnClear.style.display="block",this.iconLoader.style.display="none")}isValidInn(t){return 0==t.length||/^[-+]?\d+(\.\d*)?$/.test(t)}setFieldStatus(t,e,a,n){let i="ui-ctl-",s="ui-btn-",r="ui-ctl-tag-";["primary","success","warning","danger","disabled"].forEach((o=>{e.classList.contains(`${i}${o}`)&&e.classList.remove(`${i}${o}`),n.classList.contains(`${s}${o}`)&&n.classList.remove(`${s}${o}`),a.classList.contains(`${r}${o}`)&&a.classList.remove(`${r}${o}`),o==t&&(e.classList.add(`${i}${t}`),n.classList.add(`${s}${t}`),a.classList.add(`${r}${t}`))}))}setStatusToAction(t,e){this.method=t,"equality"==t?(this.infoTag.textContent=e||"Компания уже привязанна к этой сделке",this.setFieldStatus("warning",this.inputParent,this.infoTag,this.btnLink),this.btnLink.setAttribute("disabled",!0)):"load"==t||"default"==t?(this.infoTag.textContent="Введите 9 цифр для ИНН или 14 цифр для ПИНФЛ",this.setFieldStatus("primary",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"binding"==t||"createWithBind"==t?(this.infoTag.textContent=e||"Введите 9 цифр для ИНН или 14 цифр для ПИНФЛ",this.setFieldStatus("success",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"invalid"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent=e||"Некорректный формат ИНН",this.setFieldStatus("danger",this.inputParent,this.infoTag,this.btnLink)):"error"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent="Что-то пошло не так, попробуйте еще раз!",this.setFieldStatus("danger",this.inputParent,this.infoTag,this.btnLink)):"undefined"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent=e||"ИНН не найден",this.setFieldStatus("warning",this.inputParent,this.infoTag,this.btnLink)):(this.infoTag.textContent=e||"Привязка будет доступна после сохранения сделки",this.setFieldStatus("primary",this.inputParent,this.infoTag,this.btnLink),this.btnLink.setAttribute("disabled",!0))}}