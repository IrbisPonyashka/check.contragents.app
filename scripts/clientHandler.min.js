export default class clientHandler{constructor(t,e,n,i,a,s,r,o,l,c){this.entityId=t,this.entityElemId=e,this.fieldName=n,this.domain=i,this.input=a,this.inputParent=s,this.infoTag=r,this.btnClear=o,this.iconLoader=l,this.btnLink=c,this.btnDeleteContainer=c.parentElement.cloneNode(!0),this.btnDelete=this.btnDeleteContainer.querySelector("button"),this.messgeParent=document.querySelector("#success"),this.messgeElement=document.querySelector("#success .ui-alert"),this.btnLink.textContent="Создать",this.requisite=null,this.method=null,this.inputFieldValue=null,this.valueLength="CRM_CONTACT"==t?14:9,this.entity="CRM_CONTACT"==t?"contact":"company",this.input.setAttribute("maxlength",this.valueLength),this.input.addEventListener("input",(t=>this.processInput(t.target))),this.btnLink.addEventListener("click",(t=>this.actionChange())),this.btnDelete.addEventListener("click",(t=>this.deleteEntity(t))),this.btnClear.addEventListener("click",(t=>this.clearInput())),this.getAccesses(),0!=this.entityElemId&&this.setFieldValue(this.input,this.fieldName),setTimeout((()=>{""!=this.input.value&&(this.input.value=this.input.value.trim().replace(" ","").replace(" ",""),this.processInput(this.input))}),"1000")}async processInput(t){const e=t.value.trim().replace(" ","").replace(" ","");if(this.btnClear.style.display=e.length>0?"block":"none",null!=this.btnDeleteContainer.parentElement&&(this.inputParent.removeChild(this.btnDeleteContainer),this.btnDelete.setAttribute("disabled",!0)),this.isValidInn(e))if(0==this.entityElemId)this.setStatusToAction(),e.length==this.valueLength&&this.isValidInn(e)?sessionStorage.setItem("entityInn",e):e.length>=1&&e.length<=this.valueLength?this.setStatusToAction("invalid","Введите 9 цифр"):this.setStatusToAction("default");else if(e.length==this.valueLength&&this.isValidInn(e)){this.setLoading(!0),this.setStatusToAction("default","поиск...");const t=await this.hasThisRq(e),n=await this.hasCompanyWithInn(e,this.entityElemId),i=await this.getDataAPIbyInn(e);null!=i&&400>i?(0==n?0!=t?(this.btnLink.textContent="Создать компанию",this.setStatusToAction("createAll")):(this.btnLink.textContent="Создать",this.setStatusToAction("create")):0==Array.isArray(n)?(this.requisite=n.ID,this.btnLink.textContent="Обновить компанию",this.setStatusToAction("update")):(this.editSelectors("ui-btn-danger","ui-btn-disabled",this.btnDelete),this.editSelectors("ui-btn-danger","ui-btn-primary",this.btnDelete),this.btnDelete.removeAttribute("disabled"),this.inputParent.appendChild(this.btnDeleteContainer),this.btnDelete.textContent="Удалить компанию",this.btnLink.textContent="Перейти в компанию",this.setStatusToAction("link",`найдено дубликатов: ${n.length}`)),this.setLoading(!1)):400>=i?(this.setLoading(!1),this.setStatusToAction("undefined","Что-то пошло не так, попробуйте позже.")):(this.setLoading(!1),this.setStatusToAction("undefined"))}else t.value.length>=1&&t.value.length<=this.valueLength?this.setStatusToAction("invalid","Введите 9 цифр"):this.setStatusToAction("default");else this.setStatusToAction("invalid")}async actionChange(){this.entityElemId,this.setLoading(!0);const t=this.input.value.trim().replace(" ","").replace(" ",""),e=await this.getDataAPIbyInn(t),n=await this.getPreset("company"==this.entity?"Юр. лицо Узбекистан":"Физ. лицо Узбекистан");if("create"==this.method){await this.companyRqAdd(e,n)&&(window.top.location.href=`https://${this.domain}/crm/${this.entity}/details/${this.entityElemId}/`)}else if("createAll"==this.method){const i=await this.createCompanyWithRq(e,n,this.fieldName,t);if(i){this.setStatusToAction("link","Компания создана и заполнена"),this.btnLink.textContent="Перейти в компанию";let t=document.createElement("a");t.style.display="none",t.target="_blank",t.href=`https://${this.domain}/crm/${this.entity}/details/${i}/`,document.querySelector("#check__btn-container").appendChild(t),t.click()}}else if("update"==this.method&&null!=this.requisite){await this.companyRqUpdate(e,n,this.entityElemId,this.requisite,t)&&(window.top.location.href=`https://${this.domain}/crm/${this.entity}/details/${this.entityElemId}/`)}else if("link"==this.method){const e=await this.hasCompanyWithInn(t,this.entityElemId);let n=document.createElement("a");n.style.display="none",n.target="_blank",n.href=`https://${this.domain}/crm/${this.entity}/details/${e[0].ENTITY_ID}/`,document.querySelector("#check__btn-container").appendChild(n),n.click()}this.setLoading(!1)}async deleteEntity(t,e=this.entity){const n=this.input.value.trim().replace(" ","").replace(" ",""),i=this.domain,a=this.entityElemId,s=await this.hasCompanyWithInn(n,a);BX24.callMethod(`crm.${this.entity}.delete`,{id:a},(function(t){if(t.error())console.log(t.error());else{let t=document.createElement("a");t.style.display="none",t.target="_blank",t.href=`https://${i}/crm/${e}/details/${s[0].ENTITY_ID}/`,document.querySelector("#check__btn-container").appendChild(t),t.click(),window.top.location.href=`https://${i}/crm/${e}/details/${a}/`}}))}async getDataAPIbyInnPromise(t){var e=new Headers;return e.append("Authorization",`Bearer ${JSON.parse(sessionStorage.token).access_token}`),fetch(`https://api.multibank.uz/api/check_contragent/v1/general/${t}?refresh=0`,{method:"GET",headers:e,redirect:"follow"}).then((t=>t.ok?t:Promise.reject(t))).then((t=>t.json())).catch((t=>t.status))}async getDataAPIbyInn(t){try{const n=await this.getDataAPIbyInnPromise(t);var e="company"==this.entity?n.data.gnk.company_tin:n.data.gnk.gnk_company_director_pinfl;if(!(null==n||n>400||null==e))return n;if(401!=n)return null==n||522==n?522:null;sessionStorage.removeItem("token")}catch(t){return t}}async hasCompanyWithInnPromise(t,e,n=this.entity){return new Promise(((i,a)=>{if("company"==n)var s={RQ_INN:t};else s={UF_CRM_RQ_PINFL:t};BX24.callMethod("crm.requisite.list",{filter:s,select:["ID","NAME","RQ_COMPANY_NAME","ENTITY_ID"]},(function(t){if(t.error())i(t.error());else if(t.data().length>0){const n=t.data().filter((t=>t.ENTITY_ID==e));null!=n[0]?i(n[0]):i(t.data())}else i(!1)}))}))}async hasCompanyWithInn(t,e){try{return await this.hasCompanyWithInnPromise(t,e)}catch(t){console.log(t)}}async hasThisRqPromise(){return new Promise(((t,e)=>{BX24.callMethod("crm.requisite.list",{filter:{ENTITY_ID:this.entityElemId},select:["ID","NAME","RQ_COMPANY_NAME"]},(function(e){e.error()?console.error(e.error()):e.data().length>0?t(e.data()):t(!1)}))}))}async hasThisRq(){try{return await this.hasThisRqPromise()}catch(t){console.log(t)}}async createCompanyWithRqPromise(t,e,n,i){return new Promise(((a,s)=>{const r=t.gnk_company_director_name.split(" ");var o={TITLE:t.gnk_company_name_full};o[n]=i,BX24.callMethod(`crm.${this.entity}.add`,{fields:o,params:{REGISTER_SONET_EVENT:"Y"}},(async function(n){n.error()?a(n.error()):"Юр. лицо Узбекистан"==e.NAME?BX24.callMethod("crm.requisite.add",{fields:{ENTITY_TYPE_ID:4,ENTITY_ID:n.data(),PRESET_ID:e.ID,ACTIVE:"Y",NAME:e.NAME,RQ_INN:t.company_tin,RQ_COMPANY_NAME:t.gnk_company_name,RQ_COMPANY_FULL_NAME:t.gnk_company_name_full,RQ_DIRECTOR:t.gnk_company_director_name,RQ_ACCOUNTANT:t.gnk_company_accountant,RQ_OKVED:t.gnk_company_oked,RQ_PHONE:""}},(function(e){e.error()?a(e.error()):(BX24.callMethod("crm.address.add",{fields:{TYPE_ID:6,ENTITY_TYPE_ID:8,ENTITY_ID:e.data(),ADDRESS_1:t.gnk_company_address}}),BX24.callMethod("crm.requisite.bankdetail.add",{fields:{ENTITY_ID:e.data(),COUNTRY_ID:1,NAME:"Первичный счёт",RQ_BIK:t.gnk_company_mfo,RQ_ACC_NUM:t.gnk_company_account,RQ_ACC_CURRENCY:"Узбекский сум"}},(function(t){t.error()?a(t.error()):a(n.data())})))})):BX24.callMethod("crm.requisite.add",{fields:{ENTITY_TYPE_ID:3,ENTITY_ID:n.data(),PRESET_ID:e.ID,ACTIVE:"Y",NAME:e.NAME,RQ_LAST_NAME:t.gnk_company_director_name?r[0]:"",RQ_FIRST_NAME:t.gnk_company_director_name?r[1]:"",RQ_SECOND_NAME:t.gnk_company_director_name?r[2]:"",UF_CRM_RQ_PINFL:t.gnk_company_director_pinfl}},(function(t){t.error()?a(t.error()):a(n.data())}))}))}))}async createCompanyWithRq(t,e,n,i){try{return await this.createCompanyWithRqPromise(t.data.gnk,e,n,i)}catch(t){console.error(t)}}async companyRqAddPromise(t,e,n,i,a,s=this.entity){return new Promise(((r,o)=>{if("Юр. лицо Узбекистан"==e.NAME)BX24.callMethod("crm.requisite.add",{fields:{ENTITY_TYPE_ID:4,ENTITY_ID:this.entityElemId,PRESET_ID:e.ID,ACTIVE:"Y",NAME:e.NAME,RQ_INN:t.company_tin,RQ_COMPANY_NAME:t.gnk_company_name,RQ_COMPANY_FULL_NAME:t.gnk_company_name_full,RQ_DIRECTOR:t.gnk_company_director_name,RQ_ACCOUNTANT:t.gnk_company_accountant,RQ_OKVED:t.gnk_company_oked,RQ_PHONE:""}},(function(e){e.error()?r(e.error()):(BX24.callMethod("crm.address.add",{fields:{TYPE_ID:6,ENTITY_TYPE_ID:8,ENTITY_ID:e.data(),ADDRESS_1:t.gnk_company_address}}),BX24.callMethod("crm.requisite.bankdetail.add",{fields:{ENTITY_ID:e.data(),COUNTRY_ID:1,NAME:"Первичный счёт",RQ_BIK:t.gnk_company_mfo,RQ_ACC_NUM:t.gnk_company_account,RQ_ACC_CURRENCY:"Узбекский сум"}},(function(t){t.error()&&console.error(t.error())}))),BX24.callMethod("app.option.get",{option:"renameCompany"},(function(e){if(e.error())console.error(e.data());else{let l="false"===e.data()?"":t.gnk_company_name;t.gnk_company_director_name.split(" ");var o={TITLE:l};o[a]=i,BX24.callMethod(`crm.${s}.update`,{id:n,fields:o,params:{REGISTER_SONET_EVENT:"Y"}},(function(t){t.error()?console.error(t.error()):r(t.data())}))}}))}));else{let o=t.gnk_company_director_name.split(" ");BX24.callMethod("crm.requisite.add",{fields:{ENTITY_TYPE_ID:3,ENTITY_ID:this.entityElemId,PRESET_ID:e.ID,ACTIVE:"Y",NAME:e.NAME,RQ_LAST_NAME:t.gnk_company_director_name?o[0]:"",RQ_FIRST_NAME:t.gnk_company_director_name?o[1]:"",RQ_SECOND_NAME:t.gnk_company_director_name?o[2]:"",UF_CRM_RQ_PINFL:t.gnk_company_director_pinfl}},(function(e){e.error()?r(e.error()):(BX24.callMethod("crm.address.add",{fields:{TYPE_ID:6,ENTITY_TYPE_ID:8,ENTITY_ID:e.data(),ADDRESS_1:t.gnk_company_address}}),BX24.callMethod("app.option.get",{option:"renameCompany"},(function(e){if(e.error())console.error(e.data());else{let l="false"===e.data()?"":t.gnk_company_name;t.gnk_company_director_name.split(" ");var o={TITLE:l};o[a]=i,BX24.callMethod(`crm.${s}.update`,{id:n,fields:o,params:{REGISTER_SONET_EVENT:"Y"}},(function(t){t.error()?console.error(t.error()):r(t.data())}))}})))}))}}))}async companyRqAdd(t,e){try{return await this.companyRqAddPromise(t.data.gnk,e,this.entityElemId,this.input.value,this.fieldName)}catch(t){console.error(t)}}async companyRqUpdatePromise(t,e,n,i,a,s=this.fieldName,r=this.entity){return new Promise(((o,l)=>{if("company"==r)BX24.callMethod("crm.requisite.update",{id:i,fields:{ENTITY_TYPE_ID:4,ENTITY_ID:n,PRESET_ID:e.ID,ACTIVE:"Y",NAME:e.NAME,RQ_INN:t.company_tin,RQ_COMPANY_NAME:t.gnk_company_name,RQ_COMPANY_FULL_NAME:t.gnk_company_name_full,RQ_DIRECTOR:t.gnk_company_director_name,RQ_ACCOUNTANT:t.gnk_company_accountant,RQ_OKVED:t.gnk_company_oked,RQ_PHONE:""}},(function(e){e.error()?console.error(e.error()):BX24.callMethod("crm.requisite.bankdetail.list",{filter:{ENTITY_ID:i},select:["ID","NAME"]},(function(e){e.error()?(console.info(e.error()),o(e.error())):BX24.callMethod("crm.requisite.bankdetail.update",{id:e.data()[0].ID,fields:{COUNTRY_ID:1,NAME:"Первичный счёт",RQ_BIK:t.gnk_company_mfo,RQ_ACC_NUM:t.gnk_company_account,RQ_ACC_CURRENCY:"Узбекский сум"}},(function(e){e.error()?o(e.error()):BX24.callMethod("app.option.get",{option:"renameCompany"},(function(e){if(e.error())o(e.data());else{let l="false"===e.data()?"":t.gnk_company_name;t.gnk_company_director_name.split(" ");var i={TITLE:l};i[s]=a,BX24.callMethod(`crm.${r}.update`,{id:n,fields:i,params:{REGISTER_SONET_EVENT:"Y"}},(function(t){t.error()?(console.info(t.error()),o(t.error())):o(t.data())}))}}))}))}))}));else{var c=t.gnk_company_director_name.split(" ");BX24.callMethod("crm.requisite.update",{id:i,fields:{ENTITY_TYPE_ID:3,ENTITY_ID:n,PRESET_ID:e.ID,ACTIVE:"Y",NAME:e.NAME,RQ_LAST_NAME:t.gnk_company_director_name?c[0]:"",RQ_FIRST_NAME:t.gnk_company_director_name?c[1]:"",RQ_SECOND_NAME:t.gnk_company_director_name?c[2]:"",UF_CRM_RQ_PINFL:t.gnk_company_director_pinfl}},(function(e){if(e.error())console.error(e.error());else{"false"===e.data()||t.gnk_company_name;var i={};i[s]=a,BX24.callMethod(`crm.${r}.update`,{id:n,fields:i,params:{REGISTER_SONET_EVENT:"Y"}},(function(t){t.error()?(console.log(t.error()),o(t.error())):o(t.data())}))}}))}}))}async companyRqUpdate(t,e,n,i,a){try{return await this.companyRqUpdatePromise(t.data.gnk,e,n,i,a)}catch(t){console.error(t)}}async getPresetPromise(t){return new Promise(((e,n)=>{BX24.callMethod("crm.requisite.preset.list",{order:{ID:"ASC"},filter:{NAME:t},select:["ID","NAME"]},(function(t){t.error()?e(null):e(t.data())}))}))}async getPreset(t){try{return(await this.getPresetPromise(t))[0]}catch(t){return console.error("ERROR: "+t),t}}setFieldValue(t,e){if(sessionStorage.entityInn){t.value=sessionStorage.entityInn;var n={};n[e]=t.value,BX24.callMethod(`crm.${this.entity}.update`,{id:this.entityElemId,fields:n},(function(t){t.error()?console.error(t.error()):sessionStorage.removeItem("entityInn")}))}else BX24.callMethod(`crm.${this.entity}.get`,{id:this.entityElemId},(function(n){n.error()?console.error(n.error()):n.data()[e]&&(t.value=n.data()[e])}))}getAccesses(){BX24.callMethod("app.option.get",{},(function(t){if(t.error())console.error(t.data());else{let i=t.data();if(!sessionStorage.token){const t="2",a="wZ3rNvrzz2MnJYfI9an0W1Z7AaTgF2DwX5oP9G6z";var e=new Headers;e.append("Authorization","Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiIyIiwianRpIjoiZjE4MjhhYWVhMTZkY2JjODEzMzI1NTljYjQ0MmY3YTRhYmVjNmY1ZDE3NTE4ODYwZmVmYjE4OWNhOWIwNDdhNzk2MDZkYWEyYzkwMzcyNmYiLCJpYXQiOjE2ODk1Njk5MzguMjE3NjQxLCJuYmYiOjE2ODk1Njk5MzguMjE3NjQ3LCJleHAiOjE2ODk2NTYzMzguMTg1NjI2LCJzdWIiOiI0OTBkOGEyZi1iZDhjLTQwY2EtYmNmNy02Y2FhMjBhOTJkMTAiLCJzY29wZXMiOlsiKiJdfQ.f504EQ3tS58BpLjLyTmp0CS_ZaTNWX6DWABajorCfjnxhRKLmfOcoRsTOYabtkRP6sI4n34viQ6rYGWnE_iRe9--2Kv7nAkUNXiMcmT-DOq2jQb-xYbWU0QhhrdYh9YstgoTZDn-R2hanvY8BmQ2nccHK8gqB7u295wlxsM8kAbiR4HhmchAUHS9kGW_wAkSD-H5Yt2ChAg3w0A1LImzF_QzVx90yqZgS_-C9LBsbfE3ovVWtZnKu-9V8bcV12XKF7GR9thR-MrMLeQwg-WVKHytXuiID_-o3WDQGyOB7qkXoR6SdsAptey04iVDSpSRK0678Je5_VB74ZrJVBePz9pIrh-AjbWYWmRksIc8y7QolcHU6sLpmXlq0bSvvTKJiZDggKckFAzJqZEWfHjw8LHbC7_JZINbvipDxs0Xoddi_hClO1ONTOMgI_rMbNxhPwkPuRZXBHvbmvMMeU3IGlv-O3iDvZEGmJgg_7Him6v2oWwE_hoxTsTp-zPt_Bys3i-QIGNg8YxKhu2Ic227n1GnCLNWPOY8IaaPy5HUVVdhgBFzowWWuIiFi_HkZ8Whxn7LWRXL_uve8MZ508EPddQZoqtFffRFJ9tD8tSn9gY9TvMg7A_bB8wbUG3OMcoCdu7B75Bth5nZ_q0CIDFbFtp9Meh2batndtf2RLYhcOY");var n=new FormData;n.append("client_id",t),n.append("client_secret",a),n.append("username",i.login),n.append("password",i.password),n.append("scope",""),n.append("grant_type","password"),fetch("https://auth.multibank.uz/oauth/token",{method:"POST",headers:e,body:n,redirect:"follow"}).then((t=>t.text())).then((t=>{sessionStorage.setItem("token",t)})).catch((t=>console.log("error",t)))}}}))}editSelectors(t,e,n){n.classList.remove(e),n.classList.add(t)}showMessge(t){this.messgeElement.innerHTML=t,this.inputParent.style.display="none",this.messgeParent.style.display="block"}cleanSpaces(t){}clearInput(){this.input.value=""}setLoading(t){t?(this.btnClear.style.display="none",this.iconLoader.style.display="block"):(this.btnClear.style.display="block",this.iconLoader.style.display="none")}isValidInn(t){return 0==t.length||/^[-+]?\d+(\.\d*)?$/.test(t)}setFieldStatus(t,e,n,i){let a="ui-ctl-",s="ui-btn-",r="ui-ctl-tag-";["primary","success","warning","danger","disabled"].forEach((o=>{e.classList.contains(`${a}${o}`)&&e.classList.remove(`${a}${o}`),i.classList.contains(`${s}${o}`)&&i.classList.remove(`${s}${o}`),n.classList.contains(`${r}${o}`)&&n.classList.remove(`${r}${o}`),o==t&&(e.classList.add(`${a}${t}`),i.classList.add(`${s}${t}`),n.classList.add(`${r}${t}`))}))}setStatusToAction(t,e){this.method=t,"create"==t?(this.infoTag.textContent="новый",this.setFieldStatus("success",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"default"==t?(this.infoTag.textContent="Введите 9 цифр",this.inputParent.classList.remove("ui-ctl-primary"),this.setFieldStatus("primary",this.inputParent,this.infoTag,this.btnLink),this.btnLink.setAttribute("disabled",!0)):"update"==t?(this.infoTag.textContent="Обновление данных",this.setFieldStatus("success",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"createAll"==t?(this.infoTag.textContent=e||"Реквизиты уже заполнены. Будет создана новая компания.",this.setFieldStatus("success",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"link"==t?(this.infoTag.textContent=e||"Данная компания уже существует",this.setFieldStatus("success",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"invalid"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent=e||"Некорректный формат ИНН",this.setFieldStatus("danger",this.inputParent,this.infoTag,this.btnLink)):"error"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent="Что-то пошло не так, попробуйте еще раз!",this.setFieldStatus("danger",this.inputParent,this.infoTag,this.btnLink)):"undefined"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent="ИНН не найден",this.setFieldStatus("warning",this.inputParent,this.infoTag,this.btnLink)):(this.infoTag.textContent=e||"Заполнение будет доступно после сохранения компании",this.setFieldStatus("primary",this.inputParent,this.infoTag,this.btnLink),this.btnLink.setAttribute("disabled",!0))}}