export default class clientHandler{constructor(t,e,n,i,a,s,o,r,c,l){this.entityId=t,this.entityElemId=e,this.fieldName=n,this.domain=i,this.input=a,this.inputParent=s,this.infoTag=o,this.btnClear=r,this.iconLoader=c,this.btnLink=l,this.messgeParent=document.querySelector("#success"),this.messgeElement=document.querySelector("#success .ui-alert"),this.btnLink.textContent="Создать",this.requisite=null,this.method=null,this.type=null,this.valueLength=null,this.valueLength="14",this.entity="CRM_CONTACT"==t?"contact":"company",this.type="CRM_CONTACT"==t?"individual":"entity",this.entityObject=null,this.input.setAttribute("maxlength",this.valueLength),this.input.addEventListener("input",(t=>this.processInput(t.target))),this.renameCompanyTitle=!0,this.renameContactTitle=!0,this.entityPreset=[],this.individualPreset=[],BX24.callMethod("app.option.get",{},(async t=>{t.error()?console.error(t.data()):t.data().params&&(this.renameCompanyTitle=JSON.parse(t.data().params.renameCompany),this.renameContactTitle=JSON.parse(t.data().params.renameContact),this.entityPreset=await this.getPreset({order:{ID:"ASC"},filter:{ID:t.data().params.EntityPresetId},select:["ID","NAME"]}),this.individualPreset=await this.getPreset({order:{ID:"ASC"},filter:{ID:t.data().params.IndividaulPresetId},select:["ID","NAME"]}))})),this.btnClear.addEventListener("click",(t=>this.clearInput())),this.getAccesses(),0!=this.entityElemId&&this.setFieldValue(this.input,this.fieldName),this.input.addEventListener("input",(t=>this.processInput(t.target))),this.btnLink.addEventListener("click",(t=>this.actionChange())),this.btnClear.addEventListener("click",(t=>this.clearInput())),setTimeout((()=>{""!=this.input.value&&(this.input.value=this.input.value.trim().replace(" ","").replace(" ",""),this.processInput(this.input))}),"1000")}async processInput(t){const e=t.value.trim().replace(" ","").replace(" ","");if(this.btnClear.style.display=e.length>0?"block":"none",this.isValidInn(e))if(0==this.entityElemId)this.setStatusToAction(),9!=e.length&&14!=e.length||!this.isValidInn(e)?e.length>=1&&e.length<=this.valueLength?this.setStatusToAction("invalid","Введите 9 цифр"):this.setStatusToAction("default"):(BX24.placement.call("setValue",e),sessionStorage.setItem("entityInn",e));else if("entity"==this.type&&(e.length==this.valueLength||9==e.length)||"individual"==this.type&&e.length==this.valueLength||9==e.length||"contact"==this.entity&&14==e.length||"company"==this.entity&&null==this.type&&(14==e.length||9==e.length)&&this.isValidInn(e)){this.setLoading(!0),this.setStatusToAction("default","поиск..."),this.setValueToStorageField(e,this.fieldName);const t=await this.hasThisRq(e),n=await this.getDataAPIbyInn(e);if(null!=n&&isNaN(n)){const i=n.data.company_tin??null,a=n.data.gnk_company_director_pinfl??null,s=await this.hasCompanyWithInn(e,this.entityElemId);console.log(i,"gnkCompanyTin"),console.log(a,"gnkCompanyPinfl"),console.log(n,"dataApi"),console.log(t,"rqLinked"),0==s?0!=t?(this.btnLink.textContent="contact"==this.entity?"Создать контакт":"Создать компанию",this.setStatusToAction("createAll")):(this.btnLink.textContent="Создать",this.setStatusToAction("create")):0==Array.isArray(s)?(this.requisite=s.ID,this.btnLink.textContent="contact"==this.entity?"Обновить контакт":"Обновить компанию",this.setStatusToAction("update")):(this.btnLink.textContent="contact"==this.entity?"Перейти в контакт":"Перейти в компанию",this.setStatusToAction("link",`найдено дубликатов: ${s.length}`)),this.setLoading(!1)}else 522==n?(this.setLoading(!1),this.setStatusToAction("undefined","Что-то пошло не так, попробуйте позже.")):(this.setLoading(!1),this.setStatusToAction("undefined"))}else"entity"==this.type&&t.value.length>=1&&t.value.length<=9||"individual"==this.type&&t.value.length>=1&&t.value.length<=14||t.value.length>=1&&t.value.length<=this.valueLength?"contact"==this.entity?this.setStatusToAction("invalid","Введите 14 цифр"):this.setStatusToAction("invalid",null!=this.type?`Введите ${this.valueLength} цифр`:"Введите 9 цифр для ИНН или 14 цифр для ПИНФЛ"):this.setStatusToAction("default");else this.setStatusToAction("invalid")}async actionChange(){this.setLoading(!0);const t=this.input.value.trim().replace(" ","").replace(" ",""),e=await this.getDataAPIbyInn(t);var n=[];if(n=null!=this.type?"entity"==this.type?this.entityPreset:this.individualPreset:9==t.length?this.entityPreset:this.individualPreset,console.log(this.entityPreset,this.individualPreset),"create"==this.method){await this.companyRqAdd(e.data,n[0],this.entityElemId,t,this.fieldName)}else if("createAll"==this.method){const i=await this.createCompanyWithRq(e.data,n[0],this.fieldName,t);if(i){this.setStatusToAction("link",""+("contact"==this.entity?"Контакт создан и заполнен":"Компания создана и заполнена")),this.btnLink.textContent="contact"==this.entity?"Перейти в контакт":"Перейти в компанию";let t=document.createElement("a");t.style.display="none",t.target="_blank",t.href=`https://${this.domain}/crm/${this.entity}/details/${i}/`,document.querySelector("#check__btn-container").appendChild(t),t.click()}}else if("update"==this.method&&null!=this.requisite){await this.companyRqUpdate(e.data,n[0],this.entityElemId,this.requisite,t)}else if("link"==this.method){const e=await this.hasCompanyWithInn(t,this.entityElemId);let n=document.createElement("a");n.style.display="none",n.target="_blank",n.href=`https://${this.domain}/crm/${this.entity}/details/${e[0].ENTITY_ID}/`,document.querySelector("#check__btn-container").appendChild(n),n.click()}this.setLoading(!1)}async deleteEntity(t,e=this.entity){const n=this.input.value.trim().replace(" ","").replace(" ",""),i=this.domain,a=this.entityElemId,s=await this.hasCompanyWithInn(n,a);BX24.callMethod(`crm.${this.entity}.delete`,{id:a},(function(t){if(t.error())console.log(t.error());else{let t=document.createElement("a");t.style.display="none",t.target="_blank",t.href=`https://${i}/crm/${e}/details/${s[0].ENTITY_ID}/`,document.querySelector("#check__btn-container").appendChild(t),t.click(),BX24.placement.call("setValue",n),window.location.reload()}}))}async mergeEntity(t,e=this.entity){const n=this.domain,i=this.input.value.trim().replace(" ","").replace(" ",""),a=this.entityElemId;let s=(await this.hasCompanyWithInn(i,a)).map((t=>t.ENTITY_ID));s.push(a),BX24.callMethod("crm.entity.mergeBatch",{params:{entityTypeId:"contact"==this.entity?3:4,entityIds:s}},(function(t){if(t.error())console.log(t);else{let a=document.createElement("a");a.style.display="none",a.target="_blank","CONFLICT"==t.data().STATUS?(a.href=`https://${n}/crm/${e}/merge/?id=${s.toString()}`,document.querySelector("#check__btn-container").appendChild(a),a.click()):"SUCCESS"==t.data().STATUS&&(BX24.placement.call("setValue",i),window.location.reload())}}))}async getDataAPIbyInn(t){try{const i=sessionStorage.getItem("token");if(!i)throw new Error("Token not found in sessionStorage");const{access_token:a}=JSON.parse(i);var e=new Headers;e.append("Authorization",`Bearer ${a}`);var n={method:"GET",headers:e,redirect:"follow"};const s=await fetch(`https://api.multibank.uz/api/check_contragent/v1/gnk/${t}?refresh=1`,n),o=await s.json();return console.log("result",o),"Unauthorized"===o.message?(sessionStorage.removeItem("token"),await this.getAccesses(),this.getDataAPIbyInn(t)):o.success?(console.warn("Token is invalid or expired. Attempting to refresh..."),o):(console.warn("API returned an error:",o),o.code)}catch(t){console.log(t)}}async hasCompanyWithInn(t,e,n=this.entity){return new Promise(((i,a)=>{var s={};"company"==n?(s.RQ_INN=t,s.ENTITY_TYPE_ID=4):(s.RQ_INN=t,s.ENTITY_TYPE_ID=3),BX24.callMethod("crm.requisite.list",{filter:s,select:["ID","NAME","RQ_COMPANY_NAME","ENTITY_ID"]},(function(t){if(t.error())i(t.error());else if(t.data().length>0){const n=t.data().filter((t=>t.ENTITY_ID==e));null!=n[0]?i(n[0]):i(t.data())}else i(!1)}))}))}async hasThisRq(){return new Promise(((t,e)=>{BX24.callMethod("crm.requisite.list",{filter:{ENTITY_ID:this.entityElemId,ENTITY_TYPE_ID:"contact"==this.entity?3:4},select:["ID","NAME","RQ_COMPANY_NAME","RQ_INN"]},(function(e){e.error()?console.error(e.error()):e.data().length>0?t(e.data()):t(!1)}))}))}async createCompanyWithRq(t,e,n,i,a=this.entity){return new Promise(((s,o)=>{var r={};const c=!!t.gnk_company_director_name&&t.gnk_company_director_name.split(" ");"company"==a?r.TITLE=t.gnk_company_name:"contact"==a&&(r.LAST_NAME=c?c[0]:"",r.NAME=c?c[1]:"",r.SECOND_NAME=c?c[2]:""),r.UF_CRM_1732280688058="",r.UF_CRM_1730706873638="",r.UF_CRM_1732280758867=t.gnk_status_name,r.UF_CRM_1730706901979=t.gnk_company_address,r.UF_CRM_1730706882227=t.gnk_company_account,r.UF_CRM_1730706896133=t.gnk_company_mfo,r.UF_CRM_1730706889624=t.gnk_company_oked,r.UF_CRM_1732280703903=c?c[0]:"",r.UF_CRM_1732280711686=c?c[1]:"",r.UF_CRM_1730706908545=t.gnk_company_director_name??"",r[n]=i,BX24.callMethod(`crm.${this.entity}.add`,{fields:r,params:{REGISTER_SONET_EVENT:"Y"}},(async n=>{n.error()?s(n.error()):BX24.callBatch({crmRequisiteAdd:{method:"crm.requisite.add",params:{fields:{ENTITY_TYPE_ID:"contact"==a?3:4,ENTITY_ID:n.data(),PRESET_ID:e.ID,ACTIVE:"Y",NAME:e.NAME,RQ_INN:t.company_tin??t.gnk_company_director_pinfl,UF_CRM_RQ_PINFL:t.company_tin??t.gnk_company_director_pinfl,RQ_COMPANY_NAME:t.gnk_company_name,RQ_COMPANY_FULL_NAME:t.gnk_company_name_full,RQ_DIRECTOR:t.gnk_company_director_name+(t.gnk_company_director_tin?` - ${t.gnk_company_director_tin}`:"")+(t.gnk_company_director_pinfl?` - ${t.gnk_company_director_pinfl}`:""),RQ_ACCOUNTANT:t.gnk_company_accountant,RQ_OKVED:t.gnk_company_oked,RQ_LAST_NAME:t.gnk_company_director_name?c[0]:"",RQ_FIRST_NAME:t.gnk_company_director_name?c[1]:"",RQ_SECOND_NAME:t.gnk_company_director_name?c[2]:""}}},crmAddressAdd:{method:"crm.address.add",params:{fields:{TYPE_ID:6,ENTITY_TYPE_ID:8,ENTITY_ID:"$result[crmRequisiteAdd]",ADDRESS_1:t.gnk_company_address}}},crmBankdetailAdd:{method:"crm.requisite.bankdetail.add",params:{fields:{ENTITY_ID:"$result[crmRequisiteAdd]",COUNTRY_ID:1,NAME:"Первичный счёт",RQ_BIK:t.gnk_company_mfo,RQ_ACC_NUM:t.gnk_company_account,RQ_ACC_CURRENCY:"Узбекский сум"}}}},(t=>{s(n.data())}))}))}))}async companyRqAdd(t,e,n,i,a,s=this.entity){return new Promise(((o,r)=>{let c=t.gnk_company_director_name.split(" ");BX24.callBatch({crmRequisiteAdd:{method:"crm.requisite.add",params:{fields:{ENTITY_TYPE_ID:"contact"==s?3:4,ENTITY_ID:this.entityElemId,PRESET_ID:e.ID,ACTIVE:"Y",NAME:e.NAME,RQ_INN:t.company_tin??t.gnk_company_director_pinfl,RQ_COMPANY_NAME:t.gnk_company_name,RQ_COMPANY_FULL_NAME:t.gnk_company_name_full,RQ_DIRECTOR:t.gnk_company_director_name+(t.gnk_company_director_tin?` - ${t.gnk_company_director_tin}`:"")+(t.gnk_company_director_pinfl?` - ${t.gnk_company_director_pinfl}`:""),RQ_ACCOUNTANT:t.gnk_company_accountant,RQ_OKVED:t.gnk_company_oked,RQ_LAST_NAME:t.gnk_company_director_name?c[0]:"",RQ_FIRST_NAME:t.gnk_company_director_name?c[1]:"",RQ_SECOND_NAME:t.gnk_company_director_name?c[2]:""}}},crmAddressAdd:{method:"crm.address.add",params:{fields:{TYPE_ID:6,ENTITY_TYPE_ID:8,ENTITY_ID:"$result[crmRequisiteAdd]",ADDRESS_1:t.gnk_company_address}}},crmBankdetailAdd:{method:"crm.requisite.bankdetail.add",params:{fields:{ENTITY_ID:"$result[crmRequisiteAdd]",COUNTRY_ID:1,NAME:"Первичный счёт",RQ_BIK:t.gnk_company_mfo,RQ_ACC_NUM:t.gnk_company_account,RQ_ACC_CURRENCY:"Узбекский сум"}}}},(e=>{var r=a,l={};"company"==s&&this.renameCompanyTitle?l.TITLE=t.gnk_company_name:"contact"==s&&this.renameContactTitle&&(l.LAST_NAME=c?c[0]:"",l.NAME=c?c[1]:"",l.SECOND_NAME=c?c[2]:""),l.UF_CRM_1732280688058="",l.UF_CRM_1730706873638="",l.UF_CRM_1732280758867=t.gnk_status_name,l.UF_CRM_1730706901979=t.gnk_company_address,l.UF_CRM_1730706882227=t.gnk_company_account,l.UF_CRM_1730706896133=t.gnk_company_mfo,l.UF_CRM_1730706889624=t.gnk_company_oked,l.UF_CRM_1732280703903=c?c[0]:"",l.UF_CRM_1732280711686=c?c[1]:"",l.UF_CRM_1730706908545=t.gnk_company_director_name??"",l[r]=i,BX24.callMethod(`crm.${s}.update`,{id:n,fields:l,params:{REGISTER_SONET_EVENT:"N"}},(function(t){t.error()?(console.info(t.error()),o(t.error())):o(t.data())}))}))}))}async companyRqUpdate(t,e,n,i,a,s=this.fieldName,o=this.entity){return new Promise(((r,c)=>{const l=!!t.gnk_company_director_name&&t.gnk_company_director_name.split(" ");BX24.callBatch({crmRequisiteUpdate:{method:"crm.requisite.update",params:{id:i,fields:{ENTITY_TYPE_ID:"contact"==o?3:4,ENTITY_ID:this.entityElemId,PRESET_ID:e.ID,ACTIVE:"Y",NAME:e.NAME,RQ_INN:"contact"==o?t.gnk_company_director_pinfl:t.company_tin,RQ_COMPANY_NAME:t.gnk_company_name,RQ_COMPANY_FULL_NAME:t.gnk_company_name_full,RQ_DIRECTOR:t.gnk_company_director_name+(t.gnk_company_director_tin?` - ${t.gnk_company_director_tin}`:"")+(t.gnk_company_director_pinfl?` - ${t.gnk_company_director_pinfl}`:""),RQ_ACCOUNTANT:t.gnk_company_accountant,RQ_OKVED:t.gnk_company_oked,RQ_LAST_NAME:t.gnk_company_director_name?l[0]:"",RQ_FIRST_NAME:t.gnk_company_director_name?l[1]:"",RQ_SECOND_NAME:t.gnk_company_director_name?l[2]:""}}},crmBankdetailList:{method:"crm.requisite.bankdetail.list",params:{filter:{ENTITY_ID:i},select:["ID","NAME","ENTITY_ID"]}},crmBankdetailUpdate:{method:"crm.requisite.bankdetail.update",params:{id:"$result[crmBankdetailList][0][ID]",fields:{ENTITY_ID:i,COUNTRY_ID:1,NAME:"Первичный счёт",RQ_BIK:t.gnk_company_mfo,RQ_ACC_NUM:t.gnk_company_account,RQ_ACC_CURRENCY:"Узбекский сум"}}}},(e=>{var i=s,c={};"company"==o&&this.renameCompanyTitle?c.TITLE=t.gnk_company_name:"contact"==o&&this.renameContactTitle&&(c.NAME=l?l[0]:"",c.LAST_NAME=l?l[1]:"",c.SECOND_NAME=l?l[2]:""),c.UF_CRM_1732280688058="",c.UF_CRM_1730706873638="",c.UF_CRM_1732280758867=t.gnk_status_name,c.UF_CRM_1730706901979=t.gnk_company_address,c.UF_CRM_1730706882227=t.gnk_company_account,c.UF_CRM_1730706896133=t.gnk_company_mfo,c.UF_CRM_1730706889624=t.gnk_company_oked,c.UF_CRM_1732280703903=l?l[0]:"",c.UF_CRM_1732280711686=l?l[1]:"",c.UF_CRM_1730706908545=t.gnk_company_director_name??"",c[i]=a,BX24.callMethod(`crm.${o}.update`,{id:n,fields:c,params:{REGISTER_SONET_EVENT:"N"}},(function(t){t.error()?(console.info(t.error()),r(t.error())):r(t.data())}))}))}))}async getPreset(t){return new Promise(((e,n)=>{BX24.callMethod("crm.requisite.preset.list",t,(function(t){t.error()?e(null):e(t.data())}))}))}setFieldValue(t,e){if(console.log(t,e),sessionStorage.entityInn){t.value=sessionStorage.entityInn;var n={};n[e]=t.value,BX24.callMethod(`crm.${this.entity}.update`,{id:this.entityElemId,fields:n},(function(t){t.error()?console.error(t.error()):sessionStorage.removeItem("entityInn")}))}else BX24.callMethod(`crm.${this.entity}.get`,{id:this.entityElemId},(n=>{n.error()?console.error(n.error()):(this.entityObject=n.data(),console.log(n.data()[e]),n.data()[e]?t.value=n.data()[e]:BX24.callMethod("crm.requisite.list",{filter:{ENTITY_ID:this.entityElemId}},(e=>{console.log(e),e.error()?console.error(e.error()):e.data().length>0&&(t.value=e.data()[0].RQ_INN)})))}))}setValueToStorageField(t,e=this.fieldName){var n={};n[e]=t,BX24.placement.call("setValue",t),BX24.callMethod(`crm.${this.entity}.update`,{id:this.entityElemId,fields:n},(t=>{}))}async getAccesses(){return new Promise(((t,e)=>{BX24.callMethod("app.option.get",{},(e=>{if(e.error())console.error(e.data());else{let i=e.data();if(sessionStorage.token)t(!0);else{const e="8",a="kV6eVfCQ1u1iVR6Def4K5mMQc9M1NG5t9PS4K1IJ";var n=new FormData;n.append("grant_type","password"),n.append("client_id",e),n.append("client_secret",a),n.append("scope",""),n.append("username",i.login),n.append("password",i.password),fetch("https://auth.multibank.uz/oauth/token",{method:"POST",body:n,redirect:"follow"}).then((t=>t.text())).then((e=>{sessionStorage.setItem("token",e),t(!0)})).catch((t=>console.log("error",t)))}}}))}))}editSelectors(t,e,n){n.classList.remove(e),n.classList.add(t)}showMessge(t){this.messgeElement.innerHTML=t,this.inputParent.style.display="none",this.messgeParent.style.display="block"}cleanSpaces(t){}clearInput(){this.input.value=""}setLoading(t){t?(this.btnClear.style.display="none",this.iconLoader.style.display="block"):(this.btnClear.style.display="block",this.iconLoader.style.display="none")}isValidInn(t){return 0==t.length||/^[-+]?\d+(\.\d*)?$/.test(t)}setFieldStatus(t,e,n,i){let a="ui-ctl-",s="ui-btn-",o="ui-ctl-tag-";["primary","success","warning","danger","disabled"].forEach((r=>{e.classList.contains(`${a}${r}`)&&e.classList.remove(`${a}${r}`),i.classList.contains(`${s}${r}`)&&i.classList.remove(`${s}${r}`),n.classList.contains(`${o}${r}`)&&n.classList.remove(`${o}${r}`),r==t&&(e.classList.add(`${a}${t}`),i.classList.add(`${s}${t}`),n.classList.add(`${o}${t}`))}))}setStatusToAction(t,e){this.method=t,"create"==t?(this.infoTag.textContent="новый",this.setFieldStatus("success",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"default"==t?(this.infoTag.textContent=`Введите ${"contact"==this.entity?"14":"9"} цифр`,this.inputParent.classList.remove("ui-ctl-primary"),this.setFieldStatus("primary",this.inputParent,this.infoTag,this.btnLink),this.btnLink.setAttribute("disabled",!0)):"update"==t?(this.infoTag.textContent="Обновление данных",this.setFieldStatus("success",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"createAll"==t?(this.infoTag.textContent=e||"Реквизиты уже заполнены. "+("contact"==this.entity?"Будет создан новый контакт.":"Будет создана новая компания."),this.setFieldStatus("success",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"link"==t?(this.infoTag.textContent=e||""+("contact"==this.entity?"Данный контакт уже существует":"Данная компания уже существует"),this.setFieldStatus("success",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"invalid"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent=e||"Некорректный формат ИНН",this.setFieldStatus("danger",this.inputParent,this.infoTag,this.btnLink)):"error"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent="Что-то пошло не так, попробуйте еще раз!",this.setFieldStatus("danger",this.inputParent,this.infoTag,this.btnLink)):"undefined"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent="ИНН не найден",this.setFieldStatus("warning",this.inputParent,this.infoTag,this.btnLink)):(this.infoTag.textContent=e||"Заполнение будет доступно после сохранения "+("contact"==this.entity?"контакта":"компании"),this.setFieldStatus("primary",this.inputParent,this.infoTag,this.btnLink),this.btnLink.setAttribute("disabled",!0))}}