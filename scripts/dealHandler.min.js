export default class DealCompanyHandler{constructor(t,e,n,a,i,s,o,r,l,c){this.entityElemId=e,this.entityId=t,this.domain=a,this.input=i,this.fieldName=n,this.inputParent=s,this.infoTag=o,this.btnClear=r,this.iconLoader=l,this.btnLink=c,this.valueLength=14,this.entity="deal",this.messgeParent=document.querySelector("#success"),this.messgeElement=document.querySelector("#success .ui-alert"),this.btnLink.textContent="Привязать",this.method=null,this.input.setAttribute("maxlength",this.valueLength),this.btnClear.addEventListener("click",(t=>this.clearInput())),this.getAccesses(),this.input.value=localStorage.dealInn?localStorage.dealInn:"",0!=this.entityElemId&&this.setFieldValue(this.input,this.fieldName),this.entityPreset=[],this.individualPreset=[],BX24.callMethod("app.option.get",{},(async t=>{t.error()?console.error(t.data()):t.data().params&&(this.renameCompanyTitle=JSON.parse(t.data().params.renameCompany),this.renameContactTitle=JSON.parse(t.data().params.renameContact),this.entityPreset=await this.getPreset({order:{ID:"ASC"},filter:{ID:t.data().params.EntityPresetId},select:["ID","NAME"]}),this.individualPreset=await this.getPreset({order:{ID:"ASC"},filter:{ID:t.data().params.IndividaulPresetId},select:["ID","NAME"]}))})),this.input.addEventListener("input",(t=>this.processInputInDeal(t.target))),this.btnLink.addEventListener("click",(t=>this.actionChangeInDeal())),setTimeout((()=>{""!=this.input.value&&(this.input.value=this.input.value.trim().replace(" ","").replace(" ",""),this.processInputInDeal(this.input))}),"500")}async processInputInDeal(t){const e=t.value.trim().replace(" ","").replace(" ","");if(this.btnClear.style.display=e.length>0?"block":"none",this.isValidInn(e))if(0==this.entityElemId)this.setStatusToAction(),9==e.length||14==e.length&&this.isValidInn(e)?(BX24.placement.call("setValue",e),sessionStorage.setItem("dealInn",e)):e.length>=1&&e.length<=8?this.setStatusToAction("invalid","Введите 9 цифр для ИНН или 14 цифр для ПИНФЛ"):t.value.length>=10&&t.value.length<=13?this.setStatusToAction("invalid","Введите 14 цифр для ПИНФЛ"):this.setStatusToAction("default");else if(9==e.length||14==e.length&&this.isValidInn(e)){const t="company",a=await this.getCompanyIdByInn(e),i=this.entityElemId,s=await this.dealHasCompany(i,a,e);if(this.setLoading(!0),a)null==s?(this.btnLink.textContent="Привязать",this.setStatusToAction("binding",("contact"==t?"Контакт":"компания")+" имеется в CRM")):0!=s&&null!=s?(this.btnLink.textContent="Заменить "+("contact"==t?"контакт":"компанию"),this.setStatusToAction("binding")):(this.btnLink.textContent="Заменить "+("contact"==t?"контакт":"компанию"),this.setStatusToAction("equality",""+("contact"==t?"Контакт уже привязан к этой сделке":"Компания уже привязана к этой сделке"))),BX24.placement.call("setValue",e),this.setLoading(!1);else{const a=await this.getDataAPI(e);if(null==a||404==a)return this.setStatusToAction("undefined"),void this.setLoading(!1);if(522==a)this.setLoading(!1),this.setStatusToAction("undefined","Что-то пошло не так, попробуйте позже.");else{const i=a.data.company_tin??null,o=a.data.gnk_company_director_pinfl??null;if(console.log("gnk",a),console.log("inn",e),console.log("gnkCompanyTin",i),console.log("gnkCompanyPinfl",o),console.log("actionStatus",s),BX24.placement.call("setValue",e),s){var n=await this.getRqByEntityId(s);console.log("currentCompanyRq",n),!n||i!=n.RQ_INN&&o!=n.RQ_INN?(this.btnLink.textContent=""+("contact"==t?"Заменить контакт":"Заменить компанию"),this.setStatusToAction("createWithBind")):(this.btnLink.textContent="Заменить "+("contact"==t?"контакт":"компанию"),this.setStatusToAction("equality",""+("contact"==t?"Контакт уже привязан к этой сделке":"Компания уже привязана к этой сделке")))}else this.btnLink.textContent=""+("contact"==t?"Привязать контакт":"Привязать компанию"),this.setStatusToAction("createWithBind","Реквизиты найдены");this.setLoading(!1)}}}else e.length>=1&&e.length<=8?this.setStatusToAction("invalid","Введите 9 цифр для ИНН или 14 цифр для ПИНФЛ"):t.value.length>=10&&t.value.length<=13?this.setStatusToAction("invalid","Введите 14 цифр для ПИНФЛ"):this.setStatusToAction("default");else this.setStatusToAction("invalid")}async actionChangeInDeal(){this.setLoading(!0);const t=this.input.value.trim().replace(" ","").replace(" ",""),e="company";var n=[];n=this.entityPreset,console.log(n);const a=await this.getCompanyIdByInn(t),i=await this.dealHasCompany(this.entityElemId,a,t),s=await this.getDataAPI(t),o=await this.getNdsStatus(t);if(s.data.status_nds=o,"createWithBind"==this.method){let a=await this.createCompanyByInn(s,t,n[0],e);if(a){this.setLoading(!1),await this.bindCompanyToDeal(a,i,this.entityElemId,this.domain,s,e)&&(BX24.placement.call("setValue",t),window.location.reload())}else this.setLoading(!1),this.setStatusToAction("error")}else if("binding"==this.method&&a){this.setLoading(!1),await this.bindCompanyToDeal(a,i,this.entityElemId,this.domain,s,e)&&(BX24.placement.call("setValue",t),window.location.reload())}}async createCompanyByInn(t,e,n,a){const i=t.data;return new Promise(((t,s)=>{"Семейное предприятие"==i.gnk_na1Name||"Частное предприятие"==i.gnk_na1Name||i.gnk_na1Name;var o={};const r=!!i.gnk_company_director_name&&i.gnk_company_director_name.split(" ");"company"==a?o.TITLE=i.gnk_company_name:"contact"==a&&(o.LAST_NAME=r?r[0]:"",o.NAME=r?r[1]:"",o.SECOND_NAME=r?r[2]:""),o.UF_CRM_1732280688058="",o.UF_CRM_1730706873638="",o.UF_CRM_1732280758867=i.gnk_status_name,o.UF_CRM_1730706901979=i.gnk_company_address,o.UF_CRM_1730706882227=i.gnk_company_account,o.UF_CRM_1730706896133=i.gnk_company_mfo,o.UF_CRM_1730706889624=i.gnk_company_oked,o.UF_CRM_1732280703903=r?r[0]:"",o.UF_CRM_1732280711686=r?r[1]:"",o.UF_CRM_1730706908545=i.gnk_company_director_name??"",o[this.fieldName]=e,BX24.callMethod(`crm.${a}.add`,{fields:o,params:{REGISTER_SONET_EVENT:"N"}},(async e=>{e.error()?t(e.error()):BX24.callBatch({crmRequisiteAdd:{method:"crm.requisite.add",params:{fields:{ENTITY_TYPE_ID:"contact"==a?3:4,ENTITY_ID:e.data(),PRESET_ID:n.ID,ACTIVE:"Y",NAME:n.NAME+` ${i.gnk_na1Name??""}`,RQ_INN:i.company_tin??i.gnk_company_director_pinfl,RQ_COMPANY_NAME:i.gnk_company_name,RQ_COMPANY_FULL_NAME:i.gnk_company_name_full,RQ_DIRECTOR:i.gnk_company_director_name+(i.gnk_company_director_tin?` - ${i.gnk_company_director_tin}`:"")+(i.gnk_company_director_pinfl?` - ${i.gnk_company_director_pinfl}`:""),RQ_ACCOUNTANT:i.gnk_company_accountant,RQ_OKVED:i.gnk_company_oked,RQ_LAST_NAME:i.gnk_company_director_name?r[0]:"",RQ_FIRST_NAME:i.gnk_company_director_name?r[1]:"",RQ_SECOND_NAME:i.gnk_company_director_name?r[2]:""}}},crmAddressAdd:{method:"crm.address.add",params:{fields:{TYPE_ID:6,ENTITY_TYPE_ID:8,ENTITY_ID:"$result[crmRequisiteAdd]",ADDRESS_1:i.gnk_company_address}}},crmBankdetailAdd:{method:"crm.requisite.bankdetail.add",params:{fields:{ENTITY_ID:"$result[crmRequisiteAdd]",COUNTRY_ID:1,NAME:"Первичный счёт",RQ_BIK:i.gnk_company_mfo,RQ_ACC_NUM:i.gnk_company_account,RQ_ACC_CURRENCY:"Узбекский сум"}}}},(n=>{t(e.data())}))}))}))}async bindCompanyToDeal(t,e,n,a,i,s){return new Promise((async(o,r)=>{const l=(await this.getCompanyBindedContacts(t)).map((t=>t.CONTACT_ID)),c=i.data;var d={};d.COMPANY_ID=t,l&&l.length&&(d.CONTACT_IDS=l),d[this.fieldName]=c.company_tin??c.gnk_company_director_pinfl;const h=!!c.gnk_company_director_name&&c.gnk_company_director_name.split(" ");d.UF_CRM_1732280369451="",d.UF_CRM_1732280375361=c.gnk_company_address,d.UF_CRM_1732280382385=c.gnk_company_account,d.UF_CRM_1732280387561="",d.UF_CRM_1732280392608=c.gnk_company_mfo,d.UF_CRM_1732280399368=c.gnk_company_oked,d.UF_CRM_1732280407535=h?h[0]:"",d.UF_CRM_1732280414071=h?h[1]:"",d.UF_CRM_1732280420925=c.gnk_status_name,BX24.callMethod("crm.deal.update",{id:this.entityElemId,fields:d,params:{REGISTER_SONET_EVENT:"Y"}},(t=>{t.error()?console.error(t.error()):e?BX24.callMethod(`crm.${s}.get`,{id:e},(t=>{t.error()?console.error(t.error()):BX24.callMethod("crm.timeline.comment.add",{fields:{ENTITY_ID:n,ENTITY_TYPE:"deal",COMMENT:`${"contact"==s?"Контакт был заменен":"Компания была заменена"}. При необходимости удалите ${"contact"==s?"предыдущий":"предыдущую"} - <a href="https://${a}/crm/${s}/details/${e}/">${t.data().TITLE}</a>.`}},(function(t){t.error()?console.error(t.error()):(console.info("Добавлен новый комментарий. ID - "+t.data()),o(!0))}))})):o(!0)}))}))}async getDataAPI(t){try{const a=sessionStorage.getItem("token");if(!a)throw new Error("Token not found in sessionStorage");const{access_token:i}=JSON.parse(a);var e=new Headers;e.append("Authorization",`Bearer ${i}`);var n={method:"GET",headers:e,redirect:"follow"};const s=await fetch(`https://api.multibank.uz/api/check_contragent/v1/gnk/${t}?refresh=1`,n),o=await s.json();return console.log("result",o),"Unauthorized"===o.message?(sessionStorage.removeItem("token"),await this.getAccesses(),this.getDataAPI(t)):o.success?o:(console.warn("API returned an error:",o),o.code)}catch(t){console.log(t)}}async getNdsStatusPromise(t){var e=new Headers;e.append("Authorization",`Bearer ${JSON.parse(sessionStorage.token).access_token}`);var n={method:"GET",headers:e,redirect:"follow"};let a=new Date,i=a.getFullYear(),s=(a.getMonth()+1).toString().padStart(2,"0"),o=a.getDate().toString().padStart(2,"0");return fetch(`https://api.multibank.uz/api/edm/gnk/taxpayer_type?tin_or_pinfl=${t}&date=${`${i}-${s}-${o}`}`,n).then((t=>t.ok?t:Promise.reject(t))).then((t=>t.json())).catch((t=>t.status))}async getNdsStatus(t){try{const e=await this.getNdsStatusPromise(t);return e?e.data.name:""}catch(t){return""}}setFieldValue(t,e){if(sessionStorage.dealInn){t.value=sessionStorage.dealInn;var n={};n[e]=t.value,BX24.callMethod("crm.deal.update",{id:this.entityElemId,fields:n},(function(t){t.error()?console.error(t.error()):sessionStorage.removeItem("dealInn")}))}else BX24.callMethod("crm.deal.get",{id:this.entityElemId},(n=>{if(n.error())return console.error(n.error()),null;if(n.data()[e]&&"undefined"!=n.data()[e]&&this.isValidInn(n.data()[e])){t.value=n.data()[e];let a={};a[e]=n.data()[e],BX24.callMethod("crm.deal.update",{id:n.data().ID,fields:a},(function(t){t.error()&&console.error(t.error())}))}}))}async getAccesses(){return new Promise(((t,e)=>{BX24.callMethod("app.option.get",{},(function(e){if(e.error())console.error(e.data());else{let a=e.data();if(!sessionStorage.token){const e="8",i="kV6eVfCQ1u1iVR6Def4K5mMQc9M1NG5t9PS4K1IJ";var n=new FormData;n.append("client_id",e),n.append("client_secret",i),n.append("username",a.login),n.append("password",a.password),n.append("scope",""),n.append("grant_type","password"),fetch("https://auth.multibank.uz/oauth/token",{method:"POST",body:n,redirect:"follow"}).then((t=>t.text())).then((e=>{sessionStorage.setItem("token",e),t(!0)})).catch((t=>console.log("error",t)))}}}))}))}async getCompanyIdByInn(t){return new Promise(((e,n)=>{let a={RQ_INN:t,ENTITY_TYPE_ID:4};BX24.callMethod("crm.requisite.list",{filter:a,select:["ID","NAME","RQ_COMPANY_NAME","ENTITY_ID","RQ_INN"]},(function(t){t.error()?(console.error("ERROR: "+t.error()),e(null)):(console.log(t.data()),t.data().length?e(t.data()[0].ENTITY_ID):e(null))}))}))}async getCompanyIdById(t){return new Promise(((e,n)=>{BX24.callMethod("crm.company.get",{id:t},(function(t){t.error()?(console.error("ERROR: "+t.error()),e(null)):e(t.data())}))}))}async getCompanyBindedContacts(t){return new Promise(((e,n)=>{BX24.callMethod("crm.company.contact.items.get",{id:t},(function(t){t.error()?(console.error("ERROR: "+t.error()),e(null)):e(t.data())}))}))}async dealHasCompany(t,e,n){return new Promise(((n,a)=>{BX24.callMethod("crm.deal.get",{id:t},(t=>{if(t.error())return console.error(t.error()),null;0==t.data().COMPANY_ID||null==t.data().COMPANY_ID?n(null):t.data().COMPANY_ID==e?n(!1):n(t.data().COMPANY_ID)}))}))}async getRqByEntityId(t){return new Promise(((e,n)=>{BX24.callMethod("crm.requisite.list",{filter:{ENTITY_ID:t}},(t=>{t.error()?n(t.error()):t.data().length>0?e(t.data()[0]):e(!1)}))}))}async getPreset(t){return new Promise(((e,n)=>{BX24.callMethod("crm.requisite.preset.list",t,(function(t){t.error()?e(null):e(t.data())}))}))}showMessge(t){this.messgeElement.innerHTML=t,this.inputParent.style.display="none",this.messgeParent.style.display="block"}cleanSpaces(t){t.preventDefault();var e="";window.clipboardData&&window.clipboardData.getData?e=window.clipboardData.getData("Text"):t.clipboardData&&t.clipboardData.getData&&(e=t.clipboardData.getData("text/plain")),this.value=e.replace(/\s/g,"")}clearInput(){this.input.value=""}setLoading(t){t?(this.btnClear.style.display="none",this.iconLoader.style.display="block"):(this.btnClear.style.display="block",this.iconLoader.style.display="none")}isValidInn(t){return 0==t.length||/^[-+]?\d+(\.\d*)?$/.test(t)}setFieldStatus(t,e,n,a){let i="ui-ctl-",s="ui-btn-",o="ui-ctl-tag-";["primary","success","warning","danger","disabled"].forEach((r=>{e.classList.contains(`${i}${r}`)&&e.classList.remove(`${i}${r}`),a.classList.contains(`${s}${r}`)&&a.classList.remove(`${s}${r}`),n.classList.contains(`${o}${r}`)&&n.classList.remove(`${o}${r}`),r==t&&(e.classList.add(`${i}${t}`),a.classList.add(`${s}${t}`),n.classList.add(`${o}${t}`))}))}setStatusToAction(t,e){this.method=t,"equality"==t?(this.infoTag.textContent=e||"Компания уже привязанна к этой сделке",this.setFieldStatus("warning",this.inputParent,this.infoTag,this.btnLink),this.btnLink.setAttribute("disabled",!0)):"load"==t||"default"==t?(this.infoTag.textContent="Введите 9 цифр для ИНН или 14 цифр для ПИНФЛ",this.setFieldStatus("primary",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"binding"==t||"createWithBind"==t?(this.infoTag.textContent=e||"Введите 9 цифр для ИНН или 14 цифр для ПИНФЛ",this.setFieldStatus("success",this.inputParent,this.infoTag,this.btnLink),this.btnLink.removeAttribute("disabled")):"invalid"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent=e||"Некорректный формат ИНН",this.setFieldStatus("danger",this.inputParent,this.infoTag,this.btnLink)):"error"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent="Что-то пошло не так, попробуйте еще раз!",this.setFieldStatus("danger",this.inputParent,this.infoTag,this.btnLink)):"undefined"==t?(this.btnLink.setAttribute("disabled",!0),this.infoTag.textContent=e||"ИНН не найден",this.setFieldStatus("warning",this.inputParent,this.infoTag,this.btnLink)):(this.infoTag.textContent=e||"Привязка будет доступна после сохранения сделки",this.setFieldStatus("primary",this.inputParent,this.infoTag,this.btnLink),this.btnLink.setAttribute("disabled",!0))}}